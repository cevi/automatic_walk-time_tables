version: "3.9"

services:

  awt-docs:
    build:
      context: docs/.
      dockerfile: live.Dockerfile
    ports:
      - "4000:4000"
    volumes:
      - ./docs:/app/src
      - vitepress_dist:/app/src/.vitepress/dist
      - node_modules:/app/src/node_modules
    env_file:
      - .env.live

  awt-tile-cache:
    build: tile_caching
    env_file:
      - .env.live

  awt-mapfish:
    build: pdf_map_export/.
    ports:
      - "8080:8080"
    depends_on:
      - awt-tile-cache
    env_file:
      - .env.live

  awt-swiss-tml:
    build:
      context: swiss_TLM_api/.
      dockerfile: live.Dockerfile
    ports:
      - "1848:1848"
    volumes:
      - ./swiss_TLM_api:/app
    env_file:
      - .env.live

  awt-backend:
    build:
      context: python_program/.
      dockerfile: live.Dockerfile
    ports:
      - "5000:5000"

    volumes:
      - ./python_program:/app

    depends_on:
      - awt-mapfish
      - awt-swiss-tml
    environment:
      TZ: Europe/Zurich
    env_file:
      - .env.live

  awt-webinterface:
    build:
      context: .
      dockerfile: webinterface/live.Dockerfile
      # Used in the first stage of the Dockerfile, thus these env vars must be passed as args
      args:
        - ENVIRONMENT_FILE=.env.live

    volumes:
      - ./webinterface/src:/app/src
      # Mount git info to container
      - ./.git/HEAD:/app/.git/HEAD
      - ./.git/refs/heads/:/app/.git/refs/heads/

    ports:
      - "80:80"
    depends_on:
      - awt-backend
    env_file:
      - .env.live

volumes:
  vitepress_dist: {}
  node_modules: {}